<!DOCTYPE html>
<html lang=en>
<head>
<meta charset=utf-8>
<title>Hats Example</title>
<script src="http://sdk.altvr.com/libs/three.js/r73/build/three.js"></script>
<script src="../dist/altspace.min.js"></script>
<script src="http://sdk.altvr.com/libs/three.js/r73/examples/js/loaders/OBJMTLLoader.js"></script>
<script src="http://sdk.altvr.com/libs/three.js/r73/examples/js/loaders/MTLLoader.js"></script>
</head>
<body>
    <script>
        if (!window.altspace || !window.altspace.inClient) document.write('<h3>To view this example, please open this page in <a href="http://altvr.com"> AltspaceVR </a></h3>');

            var config = {
                models: {
					'crystalscorner': { position: { x: 0, y: 0, z: 0}, offset: { x: 0, y: 0, z: 0 } },
					'crystal': { position: { x: -2.925, y: -1.9, z: 11.125}, offset: { x: 0, y: 0, z: 0 }, rotation: { x: 0, y: 180, z: 11} }
                },
                modelScaleFactor: 1,

            };
			
			
			var scene = new THREE.Scene();
			var renderer = altspace.getThreeJSRenderer();
			
			var sphereGeo1 = new THREE.SphereGeometry(400, 20, 20, Math.PI + 0.3, -2*Math.PI);
			var texture1 = THREE.ImageUtils.loadTexture( "https://upload.wikimedia.org/wikipedia/commons/a/a1/ESO_-_The_Milky_Way_panorama_(by).jpg" );
			texture1.needsUpdate = true;
			texture1.minFilter = THREE.LinearFilter;
			texture1.magFilter = THREE.LinearFilter;
			texture1.format = THREE.RGBFormat;

            var modelNames = [];
            var loadRequest;
            var scale;
			
			var promises = [altspace.getEnclosure()];
                Promise.all(promises).then(function (array) {
                    enclosure = array[0];
                    scale = enclosure.pixelsPerMeter * config.modelScaleFactor;
                    loadModels();
                }).catch(function (err) {
                    console.log('Failed to get Altspace browser properties', err);
				});
			
			
			var sphereMaterial1 = new THREE.MeshPhongMaterial( { 
				color: 0xffffff, 
				map: texture1, 
				opacity: 0.8,
				transparent : true, 
				side: THREE.DoubleSide } );
			
			sphereMesh1 = new THREE.Mesh(sphereGeo1, sphereMaterial1);
			sphereMesh1.position.x = 0;
			sphereMesh1.position.y = 0;
			sphereMesh1.position.z = 0;		
			sphereMesh1.scale.z = -1;
			
            function loadModels() {
                var multiloader = altspace.utilities.multiloader;
                multiloader.init({
                    crossOrigin: 'anonymous',
                    baseUrl: 'models/',
                    TRACE: true//enable for debugging logs
                });
                loadRequest = new multiloader.LoadRequest();
                modelNames = Object.keys(config.models);
                for (var i = 0; i < modelNames.length; i++) {
                    var name = modelNames[i];
                    loadRequest.objUrls.push(name + '.obj');
                    loadRequest.mtlUrls.push(name + '.mtl');
                }
                multiloader.load(loadRequest, onLoaded);
            }

            function onLoaded() {

                for (var i = 0; i < loadRequest.objects.length; i++) {
                    var obj = loadRequest.objects[i];
                    var name = modelNames[i];//guaranteed to be in same order
                    var spawnPosition = new THREE.Vector3();
                    spawnPosition.copy(config.models[name].position);
                    spawnPosition.multiplyScalar(scale);
                    obj.position.copy(spawnPosition);//initial position
                    obj.scale.set(scale, scale, scale);
                    scene.add(obj);
					console.log("object added to scene" + modelNames[i]);
                }
				
				scene.add(sphereMesh1);
				sphereMesh1.scale.set(500, 500, 500);
				//altspace.getThreeJSTrackingSkeleton().then(function (skeleton) { setInterval(function () { console.log(skeleton.getJoint('Head').position); }, 1000);});
				
            }
			
					//Update & Rendering
			function animate() {
				requestAnimationFrame(animate);
				renderer.render(scene);
				sphereMesh1.rotation.x += -0.00;
				sphereMesh1.rotation.y += -0.00;
				sphereMesh1.rotation.z += -0.0000155;
			}
			
			animate();			

    </script>
</body>
</html>